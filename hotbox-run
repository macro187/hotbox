#!/usr/bin/env sh
set -eu
HOTBOX=$(CDPATH= cd -- "$(dirname -- "$0")" && pwd -P)


. $HOTBOX/lib/sh.sh


volume1=""
volume2=""
volume3=""
spec=""
name=""

while test $# -gt 0 ; do
    case $1 in
        --volume)
            shift
            test $# -gt 0 || die "Expected <volume>"
            if [ -z "$volume1" ] ; then
                volume1="$1"
            elif [ -z "$volume2" ] ; then
                volume2="$1"
            elif [ -z "$volume3" ] ; then
                volume3="$1"
            else
                die "Too many --volume's"
            fi
            shift
            ;;
        -*)
            die "Unrecognised option '$1'"
            ;;
        *)
            break
            ;;
    esac
done

test $# -gt 0 || die "Expected <spec>"
spec="$1" ; shift

test $# -gt 0 || die "Expected <name>"
name="$1" ; shift

# Remaining args are <command> and <args>

spec="${spec:-alpine}"
name="${name:-$spec}"


#
# Get image information
#
image="hotbox-$spec"

image_id="$(docker image ls -q $image)"
test -n "$image_id" || die "Image $image for spec $spec not found"

shell="$(docker inspect --format '{{ index .ContainerConfig.Labels "hotbox.shell"}}' $image_id)"
shellarg="$(docker inspect --format '{{ index .ContainerConfig.Labels "hotbox.shellarg"}}' $image_id)"
test -n "$shell" || dir "No hotbox.shell label found on container image"

workdir="$(docker inspect --format '{{ index .ContainerConfig.Labels "hotbox.workdir"}}' $image_id)"
test -n "$workdir" || dir "No hotbox.workdir label found on container image"


#
# Run a login shell if no <command> <args> were specified
#
if [ $# -eq 0 ] ; then
    set -- $shell $shellarg
fi


#
# if the hotbox isn't running, start it...
#
container_id=$(docker ps -q --filter label=hotbox.name=$name)
if [ -z "$container_id" ] ; then
    heading "Starting $name hotbox container from $image image"

    hostdir="$(pwd)"
    hostdirname="${hostdir##*/}"

    if [ -d .git ] ; then
        workdir="$workdir/$hostdirname"
    fi

    termopts=""
    if [ -n "${TERM:+x}" ] ; then
        termopts="-e TERM=$TERM"
    fi

    dockersockopts=""
    if [ -S /var/run/docker.sock ] ; then
        dockersockopts="-v /var/run/docker.sock:/var/run/docker.sock"
    fi

    x11sockopts=""
    if [ -d /tmp/.X11-unix ] ; then
        x11sockopts="-v /tmp/.X11-unix:/tmp/.X11-unix"
    fi

    displayopts=""
    if [ -n "${DISPLAY:+x}" ] ; then
        displayopts="-e DISPLAY=$DISPLAY"
    fi

    gitcredentialsopts=""
    if [ -f $HOME/.git-credentials ] ; then
        gitcredentialsopts="-v $HOME/.git-credentials:/home/$(current_user)/.git-credentials"
    fi

    echo_on
    docker run \
        --ipc=host \
        --rm \
        -it \
        $termopts \
        $dockersockopts \
        $x11sockopts \
        $displayopts \
        $gitcredentialsopts \
        --label hotbox.name=$name \
        --label hotbox.workdir=$workdir \
        --env HOTBOX_NAME=$name \
        --volume $HOTBOX:/hotbox \
        --volume $hostdir:$workdir \
        --workdir $workdir \
        \
        ${volume1:+--volume} $volume1 \
        ${volume2:+--volume} $volume2 \
        ${volume3:+--volume} $volume3 \
        \
        $image \
        \
        $@
    echo_off


#
# ...otherwise join it
#
else
    heading "Joining $name hotbox container $container_id"

    container_image="$(docker inspect --format '{{ .Config.Image }}' $container_id)"
    test "$container_image" = "$image" || \
        die "Container image $container_image does not match specified image $image"

    workdir="$(docker inspect --format '{{ index .Config.Labels "hotbox.workdir"}}' $container_id)"
    test -n "$workdir" || dir "No hotbox.workdir label found on container"

    echo_on
    docker exec \
        --interactive \
        --tty \
        --workdir $workdir \
        $container_id \
        $@
    echo_off
fi
