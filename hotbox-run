#!/usr/bin/env sh
set -eu
HOTBOX=$(CDPATH= cd -- "$(dirname -- "$0")" && pwd -P)


. $HOTBOX/lib/sh.sh


distro="$1" ; shift


hotbox_name="${HOTBOX_NAME:-default}"


#
# See if the container is already running...
#
container_id=$(docker ps -q --filter label=hotbox.name=$hotbox_name)


#
# ...and if it is, join it...
#
if [ -n "$container_id" ] ; then
    heading "Joining running $hotbox_name hotbox container"
    container_cmd="$(docker inspect --format='{{range $i, $c := .Config.Cmd}}{{if $i}} {{end}}{{$c}}{{end}}' $container_id)"
    echo_on
    docker exec -it $container_id $container_cmd
    echo_off


#
# ...otherwise start it
#
else
    hostdir="$(pwd)"
    hostdirname="${hostdir##*/}"

    workdir=/workspace
    if [ -d .git ] ; then
        workdir="$workdir/$hostdirname"
    fi

    $HOTBOX/lib/run-docker \
        --label hotbox.name=$hotbox_name \
        -e HOTBOX_NAME=$hotbox_name \
        -v $hostdir:$workdir \
        --workdir="$workdir" \
        hotbox-$distro \
        /bin/sh -l
fi
