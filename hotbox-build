#!/usr/bin/env sh
set -eu
hotbox=$(CDPATH= cd -- "$(dirname -- "$0")" && pwd -P)


. $hotbox/hotbox-sh.sh


distros="$*"
test -n "$distros" || distros="alpine ubuntu"


user=$(current_user)
uid=$(current_uid)
gid=$(current_gid)


build() {
    local distro="$1" ; shift

    $hotbox/hotbox-docker-build \
        hotbox \
        hotbox-$distro \
        --label hotbox \
        --build-arg baseimage=$distro \
        --build-arg HOTBOX_USER=$user \
        --build-arg HOTBOX_UID=$uid \
        --build-arg HOTBOX_GID=$gid \
        --build-arg HOTBOX_SHELL=/bin/sh \
        --build-arg HOTBOX_WORKDIR=/workspace
}


for distro in $distros ; do
    build $distro
done


heading "Pruning hotbox container images"
echo_on
# Add -a to also prune unorphaned intermediate images
docker image prune -f --filter label=hotbox
echo_off
