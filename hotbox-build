#!/bin/sh
set -eu
HOTBOX=$(CDPATH= cd -- "$(dirname -- "$0")" && pwd -P)


. $HOTBOX/lib/sh.sh


#
# Command line arguments
#
test $# -gt 0 || die "Expected <spec>"
spec="$1" ; shift

test $# -eq 0 || die "Unexpected argument '$1'"


#
# Read container information from <spec>
#
features=$(echo $(cd $HOTBOX/specs && $HOTBOX/lib/read-spec $spec feature))
baseimage=$(cd $HOTBOX/specs && $HOTBOX/lib/read-spec $spec baseimage | tail -n 1)
shell=$(cd $HOTBOX/specs && $HOTBOX/lib/read-spec $spec shell | tail -n 1)
shellarg=$(cd $HOTBOX/specs && $HOTBOX/lib/read-spec $spec shellarg | tail -n 1)
test -n "$baseimage" || die "No baseimage specified in $spec spec"
test -n "$shell" || die "No shell specified in $spec spec"


#
# Work out additional container information
#
image="hotbox-$spec"
user="$(current_user)"
uid="$(current_uid)"
gid="$(current_gid)"
docker_gid="$(getent group docker | cut -d: -f3)"


#
# Build container image
#
heading "Building $image container image"
echo_on
PROGRESS_NO_TRUNC=1 \
docker build \
    --progress plain \
    --network=host \
    \
    -t $image \
    \
    --label hotbox \
    --label "hotbox.features=$features" \
    --label hotbox.shell=$shell \
    --label hotbox.shellarg=$shellarg \
    \
    --build-arg baseimage=$baseimage \
    --build-arg spec=$spec \
    --build-arg user=$user \
    --build-arg uid=$uid \
    --build-arg gid=$gid \
    --build-arg docker_gid=$docker_gid \
    \
    -f - \
    $HOTBOX \
    < $HOTBOX/lib/Dockerfile
echo_off


#
# Clean up unused intermediate container images
#
heading "Pruning hotbox container images"
echo_on
docker image prune -f --filter label=hotbox
echo_off
